#!/usr/bin/env node

var shell = require('shelljs');
var publishUtils = require('../src/utils');
var path = require('path');
var packageJson = require(path.resolve('./package.json'));
var argv = require('yargs').argv;
var parseRepo = require('parse-repo');

var SKIP_BUILD = Boolean(argv['existing-output-dir'])
var OUTPUT_DIR = argv['existing-output-dir'] || 'out' + Math.ceil(Math.random() * 9999);

var defaultConfig = {
  gitUsername: 'GH Pages Bot',
  gitEmail: 'hello@ghbot.com',
  commitMessage: 'Deploy Storybook to GitHub Pages'
};

var config = Object.assign({}, defaultConfig, packageJson['storybook-deployer'] || defaultConfig);

var GIT_REMOTE = argv['remote'] || 'origin';
var TARGET_BRANCH = "gh-pages";
var BRANCH_DIR = argv['branch']
var SOURCE_BRANCH = argv['source-branch'] || 'master';
var NPM_SCRIPT = argv['script'] || 'build-storybook';
var CI_DEPLOY = Boolean(argv['ci']);
var HOST_TOKEN_ENV_VARIABLE = argv['host-token-env-variable'] || 'GH_TOKEN';
var HOST_TOKEN = process.env[HOST_TOKEN_ENV_VARIABLE];

// get GIT url
console.log('=> Getting the git remote URL');
var GIT_URL = publishUtils.exec(`git config --get remote.${GIT_REMOTE}.url`);
if (!GIT_URL) {
  console.log('This project is not configured with a remote git repo');
  process.exit(-1);
}

if (!SKIP_BUILD) {
  // clear and re-create the out directory
  shell.rm('-rf', OUTPUT_DIR);
  shell.mkdir(OUTPUT_DIR);

  // run our compile script
  console.log('=> Building storybook');
  if (packageJson.scripts[NPM_SCRIPT]) {
    publishUtils.exec('npm run ' + NPM_SCRIPT + ' -- -o ' + OUTPUT_DIR);
  } else {
    publishUtils.exec('node ./node_modules/.bin/build-storybook -o ' + OUTPUT_DIR);
  }
}
// Get our repo's branches
publishUtils.exec('git fetch');
var branches = publishUtils.exec('git ls-remote --heads origin');
branches = branches.split('\n')
branches = branches.map(function (name) {
  name = name.replace(/(?:.+\srefs[\/]heads[\/])/, '').trim()
  return name
}).filter(function (name) {
  return !!name
})

// Set up github pages
shell.mkdir(TARGET_BRANCH)
shell.cd(TARGET_BRANCH)
publishUtils.exec('git init');

publishUtils.exec('git remote add origin ' + GIT_URL);

publishUtils.exec('git fetch');
publishUtils.exec('git checkout ' + TARGET_BRANCH);
shell.mkdir('-p', BRANCH_DIR);
// go to the out directory
shell.cd(path.join('..', OUTPUT_DIR));

// copy all files in the branch directory
var files_to_move = shell.ls('-l')
files_to_move.forEach(function(f) {
  shell.cp('-rf', f.name, path.join('..',TARGET_BRANCH, BRANCH_DIR))
})

shell.cd(path.join('..', TARGET_BRANCH));

// Cleanup any deleted branches
const storybook_files = ['favicon.ico', 'iframe.html', 'index.html', 'static'].join('')

var list_sub_dirs = (a, b = '') => {
  if (!path.extname(b)) {
    var new_path = path.join(a, b)
    const files = shell.ls('-l', new_path).map(f => f.name)
    if (files.join('') == storybook_files) {
      return new_path
    }
    return files.map(b => {
      return list_sub_dirs(new_path, b)
    })
  }
}

var storybook_dirs = list_sub_dirs('./').flat(Infinity).filter(p => !!p)
storybook_dirs.forEach(sb => {
  if (!branches.includes(sb)) {
    shell.rm('-rf', sb)
  }
})
// End Cleanup

publishUtils.exec('git add .');
publishUtils.exec('git commit -m ' + JSON.stringify(config.commitMessage));

// Force push from the current repo's source branch (master by default) to the remote
// repo's gh-pages branch. (All previous history on the gh-pages branch
// will be lost, since we are overwriting it.) We redirect any output to
// /dev/null to hide any sensitive credential data that might otherwise be exposed.
console.log('=> Deploying storybook');
if (CI_DEPLOY) {
  var repositoryDetails = parseRepo(GIT_URL);

  if (repositoryDetails.host === 'github.com' && HOST_TOKEN) {
    GIT_URL = 'https://' + HOST_TOKEN + '@' + repositoryDetails.host + '/' + repositoryDetails.repository;
  }
}

publishUtils.exec('git push')
shell.cd('..');
shell.rm('-rf', OUTPUT_DIR);
shell.rm('-rf', TARGET_BRANCH);

if (TARGET_BRANCH !== 'gh-pages') {
  var rawgit_url = GIT_URL.replace('github.com', 'rawgit.com').replace('.git', '/') +
    TARGET_BRANCH + '/index.html';
  console.log('=> Storybook deployed to: ' + rawgit_url);
} else {
  console.log('=> Storybook deployed to: ' + publishUtils.getGHPagesUrl(GIT_URL));
}
